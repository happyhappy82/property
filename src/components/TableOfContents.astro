---
---
<nav id="toc-nav" class="hidden xl:block fixed right-8 top-24 w-44 max-h-[calc(100vh-8rem)] overflow-y-auto">
  <div class="border-l border-gray-200 pl-3">
    <h2 class="text-xs font-medium text-gray-400 mb-2">목차</h2>
    <ul id="toc-list" class="space-y-0.5 text-xs"></ul>
  </div>
</nav>

<script>
  function initTOC() {
    const tocList = document.getElementById('toc-list');
    const tocNav = document.getElementById('toc-nav');
    if (!tocList || !tocNav) return;

    const headings = document.querySelectorAll('article h2, article h3');
    if (headings.length === 0) {
      tocNav.style.display = 'none';
      return;
    }

    const items: { id: string; text: string; level: number }[] = [];

    headings.forEach((heading) => {
      const id = heading.id || heading.textContent?.toLowerCase().replace(/\s+/g, '-') || '';
      const text = heading.textContent || '';
      const level = parseInt(heading.tagName.substring(1));

      if (id && text) {
        items.push({ id, text, level });
      }
    });

    tocList.innerHTML = items.map((item) => `
      <li style="margin-left: ${(item.level - 2) * 0.75}rem">
        <a
          href="#${item.id}"
          data-toc-link="${item.id}"
          class="block py-0.5 transition-colors leading-snug text-gray-400 hover:text-gray-700"
        >
          ${item.text}
        </a>
      </li>
    `).join('');

    // Intersection Observer for active section
    let activeId = '';
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            activeId = entry.target.id;
            updateActiveLink(activeId);
          }
        });
      },
      { rootMargin: '-20% 0% -35% 0%' }
    );

    headings.forEach((heading) => observer.observe(heading));

    function updateActiveLink(id: string) {
      document.querySelectorAll('[data-toc-link]').forEach((link) => {
        const linkId = link.getAttribute('data-toc-link');
        if (linkId === id) {
          link.classList.remove('text-gray-400');
          link.classList.add('text-blue-600', 'font-medium');
        } else {
          link.classList.remove('text-blue-600', 'font-medium');
          link.classList.add('text-gray-400');
        }
      });
    }

    // Smooth scroll
    tocList.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.tagName === 'A') {
        e.preventDefault();
        const id = target.getAttribute('data-toc-link');
        if (id) {
          const element = document.getElementById(id);
          if (element) {
            const offset = 80;
            const elementPosition = element.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;
            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            });
          }
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', initTOC);
</script>
