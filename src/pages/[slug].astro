---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import TableOfContents from '../components/TableOfContents.astro';
import QnA from '../components/QnA.astro';
import { getSortedPropertiesData, getPropertyBySlug } from '../../lib/properties';
import { extractQnA, removeQnASection } from '../../lib/qna-utils';
import { toISOTimestamp, formatDisplayDate } from '../../lib/date-utils';
import { marked } from 'marked';

export function getStaticPaths() {
  const properties = getSortedPropertiesData();
  return properties.map((property) => ({
    params: { slug: property.slug },
  }));
}

const { slug } = Astro.params;
const property = getPropertyBySlug(slug);

if (!property) {
  return Astro.redirect('/404');
}

const baseUrl = "https://www.budongsantrendreview.xyz";
const siteName = "부동산 트렌드 리뷰";

const qnaItems = extractQnA(property.content);
const contentWithoutQnA = removeQnASection(property.content);
const url = `${baseUrl}/${encodeURIComponent(slug)}`;
const isoDate = toISOTimestamp(property.date);
const displayDate = formatDisplayDate(property.date);

// Configure marked for GFM and heading IDs
marked.use({
  gfm: true,
  breaks: false,
});

// Custom renderer for headings with IDs and external links
const renderer = new marked.Renderer();
renderer.heading = function({ text, depth }) {
  const id = text.toLowerCase().replace(/\s+/g, '-');
  return `<h${depth} id="${id}">${text}</h${depth}>`;
};
renderer.link = function({ href, title, text }) {
  const isExternal = href?.startsWith('http') && !href?.includes(baseUrl);
  const attrs = isExternal ? ' target="_blank" rel="noopener noreferrer"' : '';
  const titleAttr = title ? ` title="${title}"` : '';
  return `<a href="${href}"${titleAttr}${attrs}>${text}</a>`;
};
renderer.image = function({ href, title, text }) {
  const titleAttr = title ? ` title="${title}"` : '';
  return `<img src="${href}" alt="${text || '이미지'}" loading="lazy"${titleAttr} />`;
};

marked.use({ renderer });

const htmlContent = marked.parse(contentWithoutQnA);

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: property.title,
  description: property.excerpt,
  image: `${baseUrl}/opengraph-image.png`,
  author: {
    "@type": "Organization",
    name: siteName,
    url: baseUrl,
  },
  publisher: {
    "@type": "Organization",
    name: siteName,
    url: baseUrl,
    logo: {
      "@type": "ImageObject",
      url: `${baseUrl}/logo.png`,
      width: 200,
      height: 50,
    },
  },
  datePublished: isoDate,
  dateModified: isoDate,
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": url,
  },
  inLanguage: "ko-KR",
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "홈",
      item: baseUrl,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: property.title,
      item: url,
    },
  ],
};

const faqSchema = qnaItems.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: qnaItems.map((item) => ({
    "@type": "Question",
    name: item.question,
    acceptedAnswer: {
      "@type": "Answer",
      text: item.answer,
    },
  })),
} : null;
---

<Layout
  title={property.title}
  description={property.excerpt}
  canonical={url}
  article={{ publishedTime: isoDate, modifiedTime: isoDate }}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
  </Fragment>

  <Header />
  <TableOfContents />

  <main>
    <article class="relative">
      <nav aria-label="Breadcrumb" class="mb-4 text-sm text-gray-500">
        <ol class="flex items-center gap-2">
          <li>
            <a href="/" class="hover:text-gray-700">홈</a>
          </li>
          <li aria-hidden="true">/</li>
          <li>
            <span class="text-gray-700">{property.title}</span>
          </li>
        </ol>
      </nav>

      <div class="mb-8">
        <h1
          class="text-[42px] font-black leading-tight mb-4 text-gray-900"
        >
          {property.title}
        </h1>
        <div class="flex gap-4 text-sm text-gray-600">
          <time datetime={isoDate}>{displayDate}</time>
          <span>{property.readingTime}</span>
        </div>
      </div>

      <div class="prose prose-lg max-w-none" set:html={htmlContent} />

      <QnA items={qnaItems} />
    </article>
  </main>
</Layout>
