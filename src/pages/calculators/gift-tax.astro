---
import CalcLayout from '../../layouts/CalcLayout.astro'
---
<CalcLayout title="증여세 계산기 - 부동산 트렌드 리뷰" description="부동산 증여세를 간편하게 계산하세요. 수증자 관계별 공제, 세율 구간 자동 적용.">
    <div class="mb-6">
      <a href="/calculators" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">&larr; 계산기 목록</a>
    </div>

    <h1 class="text-2xl font-bold mb-2 dark:text-white">증여세 계산기</h1>
    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">부동산 증여 시 납부해야 할 증여세를 계산합니다.</p>

    <!-- 입력 폼 -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6">
      <form id="calc-form" class="space-y-4">
        <div>
          <label for="giftValue" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            증여재산 가액 (원)
          </label>
          <input
            type="text"
            id="giftValue"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent"
            placeholder="0"
          />
        </div>

        <div>
          <label for="relationship" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            증여자와의 관계
          </label>
          <select
            id="relationship"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent"
          >
            <option value="spouse">배우자</option>
            <option value="parent">직계존속 (부모/조부모)</option>
            <option value="child">직계비속 (자녀/손자녀)</option>
            <option value="minor_child">직계비속 (미성년자)</option>
            <option value="relative">기타 친족</option>
            <option value="other">기타</option>
          </select>
        </div>

        <div>
          <label for="previousGifts" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            기 증여재산 (최근 10년 내, 원)
          </label>
          <input
            type="text"
            id="previousGifts"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent"
            placeholder="0"
          />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">최근 10년 내 같은 증여자로부터 받은 증여재산</p>
        </div>

        <div>
          <label for="assumedDebt" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            채무인수액 (원)
          </label>
          <input
            type="text"
            id="assumedDebt"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent"
            placeholder="0"
          />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">증여재산에 담보된 채무를 인수한 경우</p>
        </div>

        <button
          type="submit"
          id="calcBtn"
          class="w-full bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition-colors"
        >
          계산하기
        </button>
      </form>
    </div>

    <!-- 에러 메시지 -->
    <div id="error" class="hidden mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
      <p id="errorText" class="text-sm text-red-600 dark:text-red-400"></p>
    </div>

    <!-- 결과 -->
    <div id="results" class="hidden space-y-4">
      <!-- 요약 -->
      <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6">
        <h2 class="text-lg font-bold text-blue-900 dark:text-blue-100 mb-4">증여세 합계</h2>
        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <span class="text-gray-700 dark:text-gray-300">총 납부세액</span>
            <span id="totalTax" class="text-xl font-bold text-blue-900 dark:text-blue-100"></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-700 dark:text-gray-300">실효세율</span>
            <span id="effectiveRate" class="text-lg font-medium text-blue-800 dark:text-blue-200"></span>
          </div>
        </div>
      </div>

      <!-- 세부 내역 -->
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
        <h3 class="text-md font-bold text-gray-900 dark:text-white mb-3">세부 내역</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">증여재산 가액</span>
            <span id="giftAmount" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">(-)채무인수액</span>
            <span id="debtDisplay" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-600">
            <span class="text-gray-600 dark:text-gray-400">증여재산 과세가액</span>
            <span id="taxableGift" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">(-)증여재산 공제</span>
            <span id="deduction" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div id="previousDeductionRow" class="flex justify-between hidden">
            <span class="text-gray-600 dark:text-gray-400">(-)기 증여재산 공제 차감</span>
            <span id="previousDeduction" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-600">
            <span class="text-gray-600 dark:text-gray-400">과세표준</span>
            <span id="taxBase" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">적용세율</span>
            <span id="taxRateDisplay" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">산출세액</span>
            <span id="calculatedTax" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 dark:text-gray-400">신고세액공제 (3%)</span>
            <span id="filingCredit" class="text-gray-900 dark:text-white font-medium"></span>
          </div>
          <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-600 font-bold">
            <span class="text-gray-900 dark:text-white">납부할 세액</span>
            <span id="finalTax" class="text-gray-900 dark:text-white"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 안내사항 -->
    <div class="mt-8 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
      <p class="text-xs text-gray-500 dark:text-gray-400">
        ※ 본 계산기는 참고용이며, 실제 세액은 관할 세무서에 확인하시기 바랍니다.
        증여재산 공제는 10년간 합산되어 적용되며, 세법 개정에 따라 공제액 및 세율이 변경될 수 있습니다.
        증여세 신고는 증여일로부터 3개월 이내에 해야 하며, 기한 내 신고 시 3% 신고세액공제를 받을 수 있습니다.
      </p>
    </div>
</CalcLayout>

<script>
  // Helper functions
  function formatNumber(n: number): string {
    return n.toLocaleString('ko-KR')
  }

  function formatManWon(amount: number): string {
    const abs = Math.abs(Math.round(amount))
    const sign = amount < 0 ? '-' : ''
    const eok = Math.floor(abs / 100000000)
    const man = Math.floor((abs % 100000000) / 10000)
    const rem = abs % 10000
    let r = sign
    if (eok > 0) {
      r += formatNumber(eok) + '억'
      if (man > 0) r += ' ' + formatNumber(man) + '만'
      if (rem > 0) r += ' ' + formatNumber(rem)
      r += '원'
    } else if (man > 0) {
      r += formatNumber(man) + '만'
      if (rem > 0) r += ' ' + formatNumber(rem)
      r += '원'
    } else {
      r += formatNumber(abs) + '원'
    }
    return r
  }

  function setupNumberInput(el: HTMLInputElement | null) {
    if (!el) return
    el.addEventListener('input', function() {
      const raw = this.value.replace(/[^0-9]/g, '')
      this.value = raw ? parseInt(raw).toLocaleString('ko-KR') : ''
    })
  }

  function getVal(id: string): number {
    const el = document.getElementById(id) as HTMLInputElement | null
    if (!el) return 0
    return parseInt(el.value.replace(/,/g, '')) || 0
  }

  // Gift deduction by relationship
  function getGiftDeduction(rel: string): number {
    switch(rel) {
      case 'spouse': return 600000000
      case 'parent': return 50000000
      case 'child': return 50000000
      case 'minor_child': return 20000000
      case 'relative': return 10000000
      default: return 0
    }
  }

  // Tax brackets (same as inheritance tax)
  function getGiftTax(taxBase: number): { tax: number, rate: number, deduction: number } {
    if (taxBase <= 0) return { tax: 0, rate: 0, deduction: 0 }
    const brackets = [
      { min: 0, max: 100000000, rate: 0.10, deduction: 0 },
      { min: 100000000, max: 500000000, rate: 0.20, deduction: 10000000 },
      { min: 500000000, max: 1000000000, rate: 0.30, deduction: 60000000 },
      { min: 1000000000, max: 3000000000, rate: 0.40, deduction: 160000000 },
      { min: 3000000000, max: Infinity, rate: 0.50, deduction: 460000000 }
    ]
    for (let i = brackets.length - 1; i >= 0; i--) {
      if (taxBase > brackets[i].min) {
        const tax = taxBase * brackets[i].rate - brackets[i].deduction
        return { tax: Math.max(0, tax), rate: brackets[i].rate, deduction: brackets[i].deduction }
      }
    }
    return { tax: 0, rate: 0, deduction: 0 }
  }

  // Setup number inputs
  setupNumberInput(document.getElementById('giftValue') as HTMLInputElement)
  setupNumberInput(document.getElementById('previousGifts') as HTMLInputElement)
  setupNumberInput(document.getElementById('assumedDebt') as HTMLInputElement)

  const form = document.getElementById('calc-form') as HTMLFormElement
  const errorDiv = document.getElementById('error') as HTMLDivElement
  const errorText = document.getElementById('errorText') as HTMLParagraphElement
  const results = document.getElementById('results') as HTMLDivElement

  form?.addEventListener('submit', (e) => {
    e.preventDefault()

    // Hide all messages
    errorDiv.classList.add('hidden')
    results.classList.add('hidden')

    // Get inputs
    const giftValue = getVal('giftValue')
    const relationship = (document.getElementById('relationship') as HTMLSelectElement)?.value || 'other'
    const previousGifts = getVal('previousGifts')
    const assumedDebt = getVal('assumedDebt')

    // Validation
    if (giftValue <= 0) {
      errorText.textContent = '증여재산 가액을 입력해주세요.'
      errorDiv.classList.remove('hidden')
      return
    }

    if (assumedDebt > giftValue) {
      errorText.textContent = '채무인수액은 증여재산 가액보다 클 수 없습니다.'
      errorDiv.classList.remove('hidden')
      return
    }

    // Calculate
    const taxableGift = giftValue - assumedDebt
    const deduction = getGiftDeduction(relationship)

    // 10년 합산 과세: 이번 증여 + 기존 증여를 합산하여 세액 산출 후 기존분 세액 차감
    const totalCumulativeGifts = taxableGift + previousGifts

    // 합산 과세표준에 대한 세액
    const cumulativeTaxBase = Math.max(0, totalCumulativeGifts - deduction)
    const cumulativeTaxResult = getGiftTax(cumulativeTaxBase)

    // 기존 증여분에 대한 세액 (차감할 금액)
    const previousTaxBase = Math.max(0, previousGifts - deduction)
    const previousTaxResult = getGiftTax(previousTaxBase)

    // 이번 증여분 산출세액 = 합산세액 - 기존분 세액
    const incrementalTax = Math.max(0, cumulativeTaxResult.tax - previousTaxResult.tax)

    // 공제 표시용 계산
    const actualDeduction = Math.max(0, Math.min(deduction, totalCumulativeGifts) - Math.min(deduction, previousGifts))
    const usedDeduction = Math.min(deduction, previousGifts)
    const taxBase = cumulativeTaxBase
    const taxResult = cumulativeTaxResult

    const filingCredit = Math.round(incrementalTax * 0.03)
    const finalTax = Math.max(0, incrementalTax - filingCredit)
    const effectiveRate = giftValue > 0 ? (finalTax / giftValue * 100).toFixed(2) : '0.00'

    // Display results
    const totalTaxEl = document.getElementById('totalTax')
    const effectiveRateEl = document.getElementById('effectiveRate')
    const giftAmountEl = document.getElementById('giftAmount')
    const debtDisplayEl = document.getElementById('debtDisplay')
    const taxableGiftEl = document.getElementById('taxableGift')
    const deductionEl = document.getElementById('deduction')
    const previousDeductionRow = document.getElementById('previousDeductionRow')
    const previousDeductionEl = document.getElementById('previousDeduction')
    const taxBaseEl = document.getElementById('taxBase')
    const taxRateDisplayEl = document.getElementById('taxRateDisplay')
    const calculatedTaxEl = document.getElementById('calculatedTax')
    const filingCreditEl = document.getElementById('filingCredit')
    const finalTaxEl = document.getElementById('finalTax')

    if (totalTaxEl) totalTaxEl.textContent = formatManWon(finalTax)
    if (effectiveRateEl) effectiveRateEl.textContent = effectiveRate + '%'
    if (giftAmountEl) giftAmountEl.textContent = formatManWon(giftValue)
    if (debtDisplayEl) debtDisplayEl.textContent = formatManWon(assumedDebt)
    if (taxableGiftEl) taxableGiftEl.textContent = formatManWon(taxableGift)
    if (deductionEl) deductionEl.textContent = formatManWon(actualDeduction)

    // Show previous deduction row only if there was a reduction
    if (previousDeductionRow && previousDeductionEl) {
      if (usedDeduction > 0) {
        previousDeductionEl.textContent = formatManWon(usedDeduction)
        previousDeductionRow.classList.remove('hidden')
      } else {
        previousDeductionRow.classList.add('hidden')
      }
    }

    if (taxBaseEl) taxBaseEl.textContent = formatManWon(taxBase)
    if (taxRateDisplayEl) taxRateDisplayEl.textContent = (taxResult.rate * 100).toFixed(0) + '%'
    if (calculatedTaxEl) calculatedTaxEl.textContent = formatManWon(incrementalTax)
    if (filingCreditEl) filingCreditEl.textContent = formatManWon(filingCredit)
    if (finalTaxEl) finalTaxEl.textContent = formatManWon(finalTax)

    results.classList.remove('hidden')
  })
</script>
